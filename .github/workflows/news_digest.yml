name: News Digest Emailer
on:
  schedule:
    # Run every 4 hours
    - cron: '0 */4 * * *'
  workflow_dispatch: # Allow manual triggering

jobs:
  send-digest:
    runs-on: ubuntu-latest
    timeout-minutes: 55 # Just under 1 hour limit
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
        cache: 'pip'
        
    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential cmake
        
    - name: Install Python dependencies
      run: |
        pip3 install --upgrade pip
        pip3 install -r requirements.txt
        
    - name: Create directories
      run: mkdir -p models
        
    - name: Check for cached model
      id: cache-model
      uses: actions/cache@v4
      with:
        path: models/mistral-7b-instruct-v0.1.Q4_K_M.gguf
        key: mistral-model-v1
        
    - name: Download Mistral model
      if: steps.cache-model.outputs.cache-hit != 'true'
      run: |
        python3 -c "
        from huggingface_hub import hf_hub_download
        import os
        hf_hub_download(
            repo_id='TheBloke/Mistral-7B-Instruct-v0.1-GGUF',
            filename='mistral-7b-instruct-v0.1.Q4_K_M.gguf',
            local_dir='./models',
            local_dir_use_symlinks=False
        )
        print('âœ… Model downloaded successfully')
        "
      env:
        HF_HUB_DISABLE_PROGRESS_BARS: 1
        
    - name: Verify model
      run: |
        if [ ! -f "models/mistral-7b-instruct-v0.1.Q4_K_M.gguf" ]; then
          echo "âŒ Model file not found!"
          exit 1
        fi
        echo "âœ… Model ready: $(ls -lh models/mistral-7b-instruct-v0.1.Q4_K_M.gguf | awk '{print $5}')"
        
    - name: Run news digest
      run: python3 main.py
      env:
        MODEL_PATH: ./models/mistral-7b-instruct-v0.1.Q4_K_M.gguf
        
    - name: Commit processed URLs
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action Bot"
        git add processed_urls.json 2>/dev/null || true
        
        if ! git diff --staged --quiet; then
          git commit -m "ðŸ“§ News digest sent - $(date '+%Y-%m-%d %H:%M UTC')"
          git push
        else
          echo "No changes to commit"
        fi
      if: always()
        
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: digest-run-${{ github.run_number }}
        path: |
          processed_urls.json
        retention-days: 7
        
    - name: Summary
      if: always()
      run: |
        echo "=== RUN SUMMARY ==="
        echo "ðŸš€ Workflow: ${{ github.workflow }}"
        echo "ðŸ“… Run: ${{ github.run_number }}"
        echo "â° Completed: $(date)"
        
        if [ -f "processed_urls.json" ]; then
          url_count=$(jq '. | length' processed_urls.json 2>/dev/null || echo "0")
          echo "ðŸ“° Total URLs processed: $url_count"
        fi
        
    - name: Clean up
      run: rm -rf models/
      if: always()